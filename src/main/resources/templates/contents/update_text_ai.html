<!DOCTYPE html>

<html layout:decorate="~{layout}"> <!-- layout.html 상속-->
<div layout:fragment="content">

   <script>
    window.onload = () => {
        let content_tag = document.getElementById('content');
        let emotion_tag = document.getElementById('emotion');
        let summary_tag = document.getElementById('summary');
        let send_tag = document.getElementById('send');
        let result_animation_tag = document.getElementById('result_animation');
        let passwd_tag = document.getElementById('passwd');
        let contentsno_tag = document.getElementById('contentsno');
  
        // emotion, summary 변수의 값이 필요함으로 동기 통신 해야함. 
        send_tag.addEventListener("click", async function() {
          let content = content_tag.value; // 작성된 글 내용
          let passwd = passwd_tag.value;
          let contentsno = contentsno_tag.value;

          // 비밀번호 체크부터 진행 (동기적으로 서버에 확인)
          const checkResponse = await fetch("/contents/password_check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contentsno, passwd })
          });
      
          const checkResult = await checkResponse.json();
          if (checkResult.res !== 1) {
            alert("비밀번호가 일치하지 않습니다.");
            return; // 중단
          }


          // 감정 분석 비동기 처리
          fetch("/contents/emotion", {
            "method": "post", 
            "headers": {"Content-Type": "application/json"},
            body: JSON.stringify({content}) // {"content": content}
          })
          .then((response) => response.json())
          .then((data) => {
            console.log('-> data:' + data);
            console.log("-> data['res']:" + data['res']);
            emotion_tag.value = data['res'];

            // 요약처리 비동기 처리
            fetch("/contents/summary", {
              "method": "post", 
              "headers": {"Content-Type": "application/json"},
              body: JSON.stringify({content}) // {"content": content}
            })
            .then((response) => response.json())
            .then((data) => {
              console.log('-> data:' + data);
              console.log("-> data['res']:" + data['res']);
              summary_tag.value = data['res'];

              result_animation_tag.style.display = 'none'; // 최종 답변이 왔음으로 animation 종료
              frm.submit();
            });
          });

          result_animation_tag.innerHTML = '<img src="/images/progress.gif" style="width: 24px; margin-top: 0px;">';
          result_animation_tag.style.display='';
        });
    };
  </script>

  <div class='title_line'>
    <span th:text="${cateVO.grp }" class="title_line_text"></span > 
    > <span th:text="${cateVO.name}" class="title_line_text"></span > 
    > 글 수정
  </div>
  
  <aside class="aside_right">
    <a th:href="@{|./create?cateno=${cateVO.cateno }|}">등록</a>
    <span class='menu_divide' >│</span>
    <a href="javascript:location.reload();">새로고침</a>
    <span class='menu_divide' >│</span>
    <a th:href="@{|./list_by_cateno_search_paging?cateno=${cateVO.cateno }|}">기본 목록형</a>    
    <span class='menu_divide' >│</span>
    <a th:href="@{|./list_by_cateno_grid?cateno=${cateVO.cateno }|}">갤러리형</a>
  </aside>
  
  <div class='menu_line'></div>
  
  <form name='frm' method='post' th:object="${contentsVO}" action='./update_text'>
    <input type="hidden" name="cateno" th:value="${cateVO.cateno }">
    <input type="hidden" id="contentsno" name="contentsno" th:value="${contentsVO.contentsno }">
    <input type="hidden" name="now_page" th:value="${now_page}">
    <input type="hidden" name="search_word" th:value="${word}">
    <input type="hidden" id="emotion" name="emotion" th:value="' '">
    <input type="hidden" id="summary" name="summary" th:value="' '">
    
    <div>
       <label>제목</label>
       <input type='text' name='title' th:value='${contentsVO.title}' required="required" 
                 autofocus="autofocus" class="form-control" style='width: 100%;'>
    </div>
    <div>
       <label>내용</label>
       <textarea id='content' name='content' required="required" class="form-control" rows="12" style='width: 100%;' 
                      th:text='${contentsVO.content}'></textarea>
    </div>
    <div>
       <label>검색어</label>
       <input type='text' name='word' th:value='${contentsVO.word}' required="required" 
                 class="form-control" style='width: 100%;'>
    </div>   
    <div>
       <label>패스워드</label>
       <input id='passwd' type='password' name='passwd' required="required" 
                 class="form-control" style='width: 50%;'>
    </div>
    <div class="content_body_bottom">
      <button type="button" id='send' class="btn btn-secondary btn-sm">저장</button>
      <button type="button" th:attr="onclick=|location.href='./list_by_cateno_search_paging?cateno=${cateno}'|" class="btn btn-secondary btn-sm">목록</button>
      <span id="result_animation" style="display: none;"></span>
    </div>
  
  </form>

</div>


